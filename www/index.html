<!-- vim: set ts=4 sw=4: -->
<!doctype html>
<html>
	<head>
		<script type="text/javascript" src="d3.min.js"></script>
		<script type="text/javascript" src="cola.v3.min.js"></script>
		<script type="text/javascript" src="jquery-2.1.4.min.js"></script>
		<script type="text/javascript" src="jquery.tablesorter.min.js"></script>
		<script type="text/javascript" src="Chart.min.js"></script>
		<script type="text/javascript" src="jquery-ui.min.js"></script>
		<script type="text/javascript" src="d3pie.min.js"></script>
		<link rel="stylesheet" href="jquery-ui.min.css">
		<script src="jquery-ui.min.js"></script>
		<meta charset="utf-8">
		<style type="text/css">
			body {
				font-family: Helvetica;
				background:#eee;
				margin:0;
				padding:0;
				overflow-y:scroll;
			}
			#overviewBoxContainer {
				clear:both;
			}
			.overviewBox {
				background:white;
				border: 1px solid #ccc;
				border-radius: 6px;
				padding:12px 24px;
				margin-right:12px;
				margin-bottom:12px;
			}
			.overviewBox.dark {
				background:#444;
				float:left;
			}
			#row1, #row2 {
				clear:both;
			}
			#col1, #col2 {
				float:left;
				width:50%;
			}
			.host:hover, .group:hover, .policy:hover, .change:hover {
				background: #ccc;
			}
			#solved .FAILED, #solved .WARNING {
				background: #99f;
				color: black;
			}
			.severity {
				font-size:0;
			}
			.FAILED {
				background: #f44;
				border: 1px solid #c44;
				padding: 0 6px;
				color: white;
			}
			.bcf10 { background: #f00; color:#f00; }
			.bcf9 { background: #f22; color:#f22; }
			.bcf8 { background: #f44; color:#f44; }
			.bcf7 { background: #f66; color:#f66; }
			.bcf6 { background: #f77; color:#f77; }
			.bcf5 { background: #f88; color:#f88; }
			.bcf4 { background: #f99; color:#f99; }
			.bcf3 { background: #faa; color:#faa; }
			.bcf2 { background: #fbb; color:#fbb; }
			.bcf1 { background: #fcc; color:#fcc; }
			.WARNING {
				background: #ff4;
				border: 1px solid #bb0;
				padding: 0 6px;
			}
			.bcw10 { background: #ff0; color: #ff0; }
			.bcw9 { background: #ff0; color: #ff0; }
			.bcw8 { background: #ff2; color: #ff2; }
			.bcw7 { background: #ff2; color: #ff2; }
			.bcw6 { background: #ff4; color: #ff4; }
			.bcw5 { background: #ff4; color: #ff4; }
			.bcw4 { background: #ff4; color: #ff4; }
			.bcw3 { background: #ff6; color: #ff6; }
			.bcw2 { background: #ff6; color: #ff6; }
			.bcw1 { background: #ff6; color: #ff6; }
			.UNKNOWN {
				background: #eee;
				border: 1px dotted #aaa;
				color: #7f7;
				padding: 0 6px;
			}
			.OK {
				background: #7f7;
				border: 1px solid #4c4;
				color: #7f7;
				padding: 0 6px;
			}
			.compliant {
				background: #7f7;
				border: 1px solid #4c4;
				color: black;
				padding: 0 6px;
			}
			.errorbox {
				padding: 24px;
				margin:12px;
				background: #f44;
				border: 3px solid #f22;
			}
			.description {
				display:none;
			}
			#logo {
				background: #222;
				padding:6px 12px;
				font-size:150%;
				font-weight:bold;
				float:left;
				margin-right:12px;
			}
			#logo a {
				text-decoration: none;
				color: #eee;
			}
			#menu {
				background: #353535;
				color:silver;
			}
			#menuOptions {
				padding: 12px;
			}
			#menuOptions a {
				color: #ddd;
				text-decoration:none;
				border:1px solid #666;
				border-bottom: 1px solid #000;
				border-right: 1px solid #000;
				background: #555;
				padding-left:12px;
				padding-right:12px;
				margin-right:12px;
				border-radius: 4px;
			}
			#menuOptions a:hover {
				color: white;
				background: #777;
			}
			#menuOptions a.current {
				color: #444;
				font-weight:bold;
				background: #eee;
			}
			#results {
				padding: 12px;
			}
			.resultTable {
				border: 1px solid #aaa;
				font-size:11pt;
				border-collapse: collapse;
			}
			.resultTable th {
				background: #ddd;
				border: 1px solid #aaa;
			}
			.resultTable td {
				padding: 6px 12px;
				border: 1px solid #aaa;
				word-wrap: break-word;
				vertical-align: top;
			}
			.resultTable .policy {
				font-size:110%;
			}
			tr:nth-child(even) {
				background:#eee;
			}
			tr:nth-child(odd) {
				background:white;
			}
			th.headerSortUp:after {
				content: " ↑";
			}
			th.headerSortDown:after {
				content: " ↓";
			}
			td.groupByValue, td.message {
				word-break: break-all;
				min-width:50%;
			}
			.search {
				clear:both;
				margin-bottom:12px;
			}
			.badges {
				height:260px;
			}
			.badges, .chart {
				border:1px solid #aaa;
				border-radius:6px;
				float:left;
				margin-bottom:12px;
				margin-right:12px;
				background:white;
			}
			.badgesTitle, .chartTitle {
				text-align:center;
				font-size:120%;
				font-weight:bold;
				margin-top:6px;
				overflow: hidden;
			}
			.badgesTitle {
				width: 250px;
			}
			.badge {
				width: 75px;
				float: left;
				padding:12px;
				margin:12px;
				text-align:center;
				border-radius:6px;
				background: #eee;
				border: 2px solid #ccc;
			}
			.badge.warning {
				background: #ff4;
				border: 2px solid #ee3;
			}
			.badge.problems {
				background: #F44;
				border: 2px solid #e33;
				color:white;
			}
			.badge .count {
				font-size:300%;
			}
			h3 {
				clear:both;
			}
			#histogramChart {
				margin:12px;
			}
			#filterSettings {
				background: #ddd;
				border: 1px solid #aaa;
				padding:6px 12px;
				margin:6px 0;
			}
			#filterSettings hr {
				display:none;
			}
		@media (max-width: 1023px) {
			#filterSettings select {
				max-width:20%;
			}
			#filterSettings #calendar {
				display:none;
			}
		}
		@media (min-width: 1024px) {
			#filterSettings {
				float: left;
				margin:0;
				margin-right:12px;
			}
			#filterSettings #datepicker, #filterSettings .datepicker {
				display:none;
			}
			#filterSettings .label {
				font-weight:bold;
				margin-top:12px;
			}
			#filterSettings hr {
				display:block;
			}
			#filterSettings select {
				display:block;
				width:300px;
				margin-bottom:6px;
			}
			#filterSettings input[type='text'] {
				display:block;
				width:292px;
				margin-bottom:6px;
			}
			textarea#copyHostList {
				height:250px;
			}
		}
			.ui-datepicker .ui-datepicker-header {
				background:#555;
				border:0;
				padding:0;
				font-size: 0.8em;
			}
			.ui-datepicker table {
				background:white;
			}
			.ui-datepicker tr {
				background:white;
				font-size: 0.8em;
			}
			.ui-datepicker td a {
				text-align:center;
			}
			.ui-datepicker td.unavailable a {
				color:#ccc;
				border:0;
				background:white;
			}
			.ui-datepicker td a.ui-state-active {
				color:white;
				background:#444;
			}
			.ui-datepicker .ui-datepicker {
				width:298px;
				padding:0;
				margin-bottom:12px;
			}
			.ui-datepicker .ui-datepicker-next, .ui-datepicker .ui-datepicker-prev {
				height:1.5em;
			}
			.ui-datepicker .ui-datepicker-next:after {
				margin-left:0.7em;
				content: ">";
			}
			.ui-datepicker .ui-datepicker-prev:after {
				margin-left:0.7em;
				content: "<";
			}
			#overviewCalendar table {
				height:222px;
			}
			#overviewCalendar td {
				font-size: 1.2em;
			}
			textarea#copyHostList {
				width:100%;
			}
			#hostmap {
				overflow:auto;
			}
			.hostMapGroup {
				width:100%;
				background:#ddd;
				border-bottom:1px dashed #fff;
			}
			.hostMapGroup tr {
				background:#ddd;
			}
			.hostMapGroup .title {
				font-size:80%;
				width:200px;
				margin:3px 0;
				padding:0 6px;
			}
			.hostMapGroup .boxes {
			}
			.hostMapBox {
				width:12px;
				height:12px;
				float:left;
				margin:2px;
				font-size:2px;
				text-align:center;
				padding:0;
			}
			.hostMapBox:hover {
				cursor: pointer;
			}
			.tooltip{
				margin:3px;
				padding:3px;
				border:1px solid #777;
				background-color:white;
				position: absolute;
				z-index: 2;
			}
			#findingsPies {
				height:260px;
				padding:0 24px;
			}
			div.pie {
				float:left;
			}



.link {
  stroke: #aaa;
}

.node text {
stroke:#333;
cursos:pointer;
}

.node circle{
stroke:#fff;
stroke-width:3px;
fill:#555;
}

.guideline {
 //   stroke: orangered;
  //  stroke-width: 4px;
}


svg .link-line {
	fill: none;
	stroke: #000;
	stroke-width: 2.0px;
	marker-end: url(#end-arrow);
}
		</style>
	</head>
	<body>
		<div id='menu'>
			<div id='logo'>
			<a href='https://github.com/lwindolf/polscan'>Polscan</a>
			</div>
			<div id='menuOptions'>
			<a href="#">Overview</a>
			<a href="#view=hostmap">Hosts Map</a>
			<a href="#view=netmap">Net Map</a>

			Findings: 
			<a href="#view=results&fG=all">All</a>
			<a href="#view=results&fG=new">New</a>
			<a href="#view=results&fG=solved">Solved</a>
			</div>
		</div>

		<div id='errors'>
		</div>
		<div id='results'>
		</div>

		<script>
			var resultCache = new Array();
			var hostGroupNamespaces = new Array();
			var hostGroups;
			var hosts;
			var currentResultSet;
			var groupBy = new Array();
			var baseUrl = "results/latest/";
			var loading = 0;
			var warning = 0;
			var failed = 0;

			function error(text) {
				$('#errors').html('<div class="errorbox"><b>Error:</b> '+text+'</div>');
				$('#errors').show();
			}

			function onCopyHosts() {
				$('#hostlist').html('<textarea id="copyHostList">');
				var hosts = $('td.host:visible').get();
				var tmp = new Array();
				for(var i = 0; i < hosts.length; i++) {
					if(!tmp[hosts[i].innerHTML])
						$('#hostlist textarea').append(hosts[i].innerHTML + " ");
						tmp[hosts[i].innerHTML] = 1;
					}
					$('#hostlist').show();
			}

			function createGroupTable(params, id, results) {
				var filteredHosts = get_hosts_filtered(params)

				$('.resultTable').empty();
				$('.resultTable').remove();
				$("<table id='resultTable"+params.fG+"' class='resultTable tablesorter'>")
				.html("<thead><tr><th>"+params.gI+"</th><th>Count</th><th>Hosts</th></thead>")
				.appendTo(id);
				$('<tbody id="groupedData">').appendTo('#resultTable'+params.fG);

				console.log("Grouping hosts by '"+params.gI+"'");
				console.time("grouping");
				var hosts = new Array();
				var values = new Array();
			   	$.each(results, function( i, item ) {
					if(item.message.indexOf(params.gI) == -1)
						return;

					if(params.sT &&
					   !((item.host.indexOf(params.sT) != -1) ||
					     (item.policy.indexOf(params.sT) != -1) ||
					     (item.message.indexOf(params.sT) != -1)))
						return;

					if(-1 == filteredHosts.indexOf(item.host))
						return;

					// Split message after colon by commata (if there is at 
					// least one or by spaces...
					var listStr = item.message.substring(params.gI.length + 2);
					var list;

					if(listStr.indexOf(',') != -1)
						list = listStr.split(/\s*,\s*/);
					else
						list = listStr.split(/\s+/);

					for(var key in list) {
						if(list[key] == "")
							continue;

						if(values[list[key]] === undefined)
							values[list[key]] = 1;

						if(hosts[list[key]] === undefined)
							hosts[list[key]] = new Array();
						hosts[list[key]].push(item.host);
					}
				});
				console.timeEnd("grouping");

				console.time("table");
				console.time("tablebuild");
				var rows = new Array(250);
				for(var key in values) {
					var hostlinks = "";
					for(var h in hosts[key])
						hostlinks += "<a href='javascript:setLocationHash({ fG: \"all\", sT: \""+hosts[key][h]+"\"}, true);'>"+hosts[key][h]+"</a> ";
					rows.push('<tr><td class="groupByValue">' + key + '</td>' +
						  '<td class="count">' + hosts[key].length + '</td>' +
					          '<td class="hosts">' + hostlinks + '</td></tr>');
					// Avoid OOM
					if(rows.length >= 250) {
						document.getElementById('groupedData').innerHTML += rows.join(" ");
						rows = new Array(250);
					}
				}
				document.getElementById('groupedData').innerHTML += rows.join(" ");
				console.timeEnd("tablebuild");
				console.timeEnd("table");

				console.time("sorting");
				$("#resultTable"+params.fG).tablesorter({sortList: [[1,1]]});
				console.timeEnd("sorting");
			}

			function createResultTable(params, id, data) {
				var filteredHosts = get_hosts_filtered(params)
				var group = '';
				var name = params.fG;

				if(!name)
					name = 'all';

				if (name == 'all' || name == 'new' || name == 'solved')
					group = '<th>Group</th>';

				$("<table id='resultTable"+name+"' class='resultTable tablesorter'>")
				.html("<thead><tr><th>Host</th>"+group+"<th>Policy</th><th title='Severity'>&nbsp;</th><th>Details</th></thead>")
				.appendTo(id);
				$('<tbody>').appendTo('#resultTable'+name);

				groupBy = new Array();
				var rows = "";
				warning = 0;
				failed = 0;
			   	$.each(data, function( i, item ) {
					var severity = 0;

					if(!params.sT && item.severity == 'OK')
						return;

					if(-1 == filteredHosts.indexOf(item.host))
						return;

					if(params.sT &&
					   !((item.host.indexOf(params.sT) != -1) ||
					     (item.policy.indexOf(params.sT) != -1) ||
					     (item.message.indexOf(params.sT) != -1)))
						return;

					if(item.severity == 'FAILED') {
						failed++;
						severity = 2;
					}
					if(item.severity == 'WARNING') {
						warning++;
						severity = 1;
					}

					rows += '<tr><td class="host">' + item.host + '</td>';
					if(item.group)
						rows += '<td class="group">' + item.group + '</td>';
					rows +=
					'<td class="policy">' + item.policy + '</td>' +
					'<td class="severity '+item.severity+'">'+severity+'</td>' +
					'<td class="message">' + item.message + '</td></tr>';
			
					// Fill array of possible groupings
					//
					// A group is indicated by a colon in the detail message
					// followed by any whitespace or comma separated list.
					var pos = item.message.indexOf(':');
					if(pos != -1) {
						var groupByStr = item.message.substring(0, pos); 
						if(groupBy[groupByStr] === undefined) {
							groupBy[groupByStr] = 1;
						} else {
							groupBy[groupByStr]++;
						}
					}
				});
				console.log("Parsing done");
				$("#resultTable"+name+" tbody").append(rows);
				console.log("Table setup done.");
				$("#resultTable"+name).tablesorter({sortList: [[2,1],[0,0]]});
				console.log("Table sorting done.");

				if(groupBy.length >= 0) {
					var groupingEnabled = false;
					for(key in groupBy) {
						if(groupBy[key] > 3 && key.length > 3) {
							groupingEnabled = true;
							$('#groupById').append("<option>"+key+"</option>");
						}
					}
					if(groupingEnabled)
						$('#groupById').removeAttr('disabled');
				}

				$("#resultTable"+name+" .group").click(function() {
					setLocationHash({ fG: $(this).html()}, true);
				});
				$("#resultTable"+name+" .policy").click(function() {
					setLocationHash({ fG: name, sT: $(this).html()}, true);
				});
				$("#resultTable"+name+" .host").click(function() {
					setLocationHash({ fG: name, sT: $(this).html()}, true);
				});
			}

			/* Generic JSON fetcher. Returns already loaded stuff from
			   result cache array.
			 */
			function getData(name, callback) {
				var cacheName = name.replace('-', '_');

				if(resultCache[cacheName]) {
					console.log("Using "+name+".json from cache");
					currentResultSet = cacheName;
					callback(resultCache[cacheName]);
					return;
				}

				$.getJSON(baseUrl + name + ".json", {})
		        	 .done(function(data) {
					currentResultSet = cacheName;
					resultCache[cacheName] = data;
					callback(data);
				})
				.fail(function(j, t, e) {
					error('Fetching results for group "'+name+'" failed! Maybe there is no data for this day?<br/><br/>Exception: ' + e);
				});
			}

			function getGroupByHost(groupType, host) {
				if(groupType in hostGroupNamespaces) {
					for(name in hostGroups) {
						if(name.indexOf(groupType) == 0 &&
						   hostGroups[name].indexOf(host) != -1)
							return name.split(/::/)[1];
					}
				}
				return 'Ungrouped';
			}

			function get_hosts_filtered(params) {
				var hg = undefined;
				var results = new Array();

				if(params.fT && params.fV)
					hg = params.fT + "::" + params.fV;

				for(host in hosts) {
					if(!hg || params.fV == getGroupByHost(params.fT, host))
						results.push(host);
				}

				return results;
			}

			function addHostsToMap(params) {
				getData(params.fG, function(data) {
					var findingsByHost = new Array();
					var filteredHosts = get_hosts_filtered(params)

					$.each(data.results, function(i, item) {
						findingsByHost[item.host] += item.severity.substring(0,1);
					});

					for (h in filteredHosts) {
						var host = filteredHosts[h];
						var value = findingsByHost[host];
						var html = "<div host='"+host+"' class='hostMapBox ";
						var count;

						if(!value)
							value = "";
						if(-1 != value.indexOf('F')) {
							count = (value.match(/F/g) || []).length;
							html += "FAILED bcf"+((count>10)?10:count);
						} else if(-1 != value.indexOf('W')) {
							count = (value.match(/W/g) || []).length;
							html += "WARNING bcw"+((count>10)?10:count);
						} else if(-1 != value.indexOf('O')) {
							html += "OK";
						} else {
							html += "UNKNOWN";
						}
						html += "' onclick='setLocationHash({ fG: \"all\", sT: \""+host+"\"}, true)'>&nbsp;</div> ";
						var groupName = getGroupByHost(params.gT, host);
						var groupClassName = groupName.replace(/[\.#]/g, "");
						if($('#hostmap').find('#'+groupClassName).length == 0)
							$('#hostmap').append('<div class="hostMapGroup" id="'+groupClassName+'"><table><tr><td class="title">'+groupName+'</td><td class="boxes"></td></tr></table></div>');
						$('#' + groupClassName + ' .boxes').append(html);
					}

					addHostMapTooltip();
				});
			}

			// Add all findings group names to a <select>
			function loadFindingGroups(id, selected) {
				$('#'+id).append(
					'<option value="all">&lt;All></option>'+
					'<option value="new">&lt;New></option>'+
					'<option value="solved">&lt;Solved></option>'
				);
				getData("overview", function(data) {
					$.each(data.overview, function(i, item) {
						if(item.group) {
							$('#'+id).append('<option value="'+item.group+'">'+item.group+'</option>');
						}
					});
					$('#'+id+" option[value='"+selected+"']").attr('selected', true);
				});
			}

			// Add all host group types to a <select>
			function loadHostGroupTypes(data, id, groupType, noneAllowed) {
				hostGroups = data;
				$.each(data, function(name, list) {
					var ns = name.split(/::/)[0];
					if(ns in hostGroupNamespaces)
						hostGroupNamespaces[ns]++;
					else
						hostGroupNamespaces[ns]=1;
				});

				if (noneAllowed)
					$('#'+id).append('<option></option>');
				for(hg in hostGroupNamespaces) {
					$('#'+id).append('<option '+((hg == groupType)?'selected':'')+' value="'+hg+'">'+hg+'</option>');
				}
			}

			// Add all host group values to a <select>
			var hgValues;
			function loadHostGroupValues(data, id, group, value, noneAllowed) {
				hgValues = new Array();
				$.each(data, function(name, list) {
					if(group == name.split(/::/)[0]) {
						var v = name.split(/::/)[1];
						hgValues.push(v);
					}
				});

				$('#'+id).children().remove();
				if (noneAllowed)
					$('#'+id).append('<option></option>');
				hgValues = hgValues.sort();
				for(var i = 0; i < hgValues.length; i++) {
					$('#'+id).append('<option '+(value==hgValues[i]?'selected ':'')+'value="'+hgValues[i]+'">'+hgValues[i]+'</option>');
				}
			}

			function addHostMapTooltip() {
				
				var changeTooltipPosition = function(event) {
					var tooltipX = event.pageX + 8;
					var tooltipY = event.pageY + 8;

					if(tooltipX > $(window).width() * 2 / 3 - 16)
						tooltipX = $(window).width() * 2 / 3 - 16;

					$('div.tooltip').css({
						top: tooltipY,
						left: tooltipX,
						width: $(window).width() / 3
					});
				};

				var showTooltip = function(event) {
					var host = $(this).attr('host');
					var details = "";
					var okFound = false;
					var cache = resultCache[$('#findingsGroup').val().replace('-', '_')];

					if(!cache)
						console.log("Fatal: no cache for "+$('#findingsGroup').val());
					else
						$.each(cache.results, function(i, item) {
							if(item.host == host) {
								if(item.severity == "OK") {
									okFound = true;
								} else {
									details += "<tr>";
									if(item.group)
										details += "<td class='group'>" + item.group + "</td>";
									details += "<td class='policy "+item.severity+"'>" + item.policy + "</td><td class='message'>" + ((item.message.length>100)?item.message.substring(0,100)+" [...]":item.message) + "</td></tr>";
								}
							}
						});
					if(details == "")
						if(okFound)
							details = "<br/><br/>No problematic findings here.";
						else
							details = "<br/><br/>No findings at all. This usually means the policies of this group don't apply to this host.";

	  				$('div.tooltip').remove();
					$('<div class="tooltip"><b>'+host+'</b><table class="resultTable">'+details+'</table></div>').appendTo('#hostmap');
					changeTooltipPosition(event);
				};

				var hideTooltip = function() {
				   $('div.tooltip').remove();
				};

				$("div.hostMapBox").bind({
				   mousemove : changeTooltipPosition,
				   mouseenter : showTooltip,
				   mouseleave: hideTooltip
				});
			}

			function addCalendar(id, initialDate) {
				$(id).datepicker({
					dateFormat: "yy/mm/dd",
					firstDay: 1,
					defaultDate: new Date(initialDate),
					onSelect: function(date) { setLocationHash({ d: date }); }
				});
				getData('host_groups', function(data) {
					// Run some histogram based calendar marking magic
					getData('histogram', function(data) {
						var yearMonth = data.date.substring(0, data.date.length - 2);
						for(i = 1; i <= 31; i++) {
							var day = ((i<10)?"0":"") + i;
							var td = $(id + ' td').filter(function() {
								return $(this).text() == ""+i; 
							});
							if(-1 != data.labels.indexOf(yearMonth+day))
								td.addClass('available');
							else
								td.addClass('unavailable');
						}
					});
				});
			}

			function addFilterSettings(id, params, callback) {
				$(id).append('<div id="filterSettings">');
				$('#filterSettings').append("<span class='label datepicker'>Date</span> <input type='text' id='datepicker' size='10'/> "+
				"<span id='calendar'></span>" +
				'<span class="label">Findings</span> <select id="findingsGroup"></select> ');

				if(params.view == 'hostmap')
					$('#filterSettings').append('<span class="label">Group Hosts by</span> <select id="hostmapGroupType"></select> ');
				if(!params.view || params.view == 'results') {
					$('#filterSettings').append('<span class="label">Group Hosts By</span> <select id="groupById"><option name="none"></option></select> ');
					if(params.gI && params.gI != '')
						$('#groupById').append('<option name="'+params.gI+'" selected>'+params.gI+'</option>');
				}

				$('#filterSettings').append('<span class="label">Filter by</span> <select id="hostmapFilterType"></select><select id="hostmapFilterValue"/></select> ');

				if(!params.view || params.view == 'results')
					$('#filterSettings').append('<span class="label">Search</span> <input type="text" width="100%" id="search"/> ')
				$('#filterSettings').append('<input id="filterSettingsGo" type="button" value="Apply"/> ');

				if(!params.view || params.view == 'results')
					$('#filterSettings').append('<hr/><input type="button" value="Switch to Hosts Map" onclick="setLocationHash({ view: \'hostmap\' });"/><input type="button" value="Get Hosts" title="Click here to get a text field with a whitespace separated list of all hosts in the result list" onclick="onCopyHosts();"/> ' + 
					'<div id="hostlist"/>');

				$(id + " *").attr('disabled', true);
				$("#datepicker").datepicker({
					dateFormat: "yy/mm/dd"
				});
				addCalendar("#calendar", params.d);
				getData('host_groups', function(data) {
					try {
						loadFindingGroups('findingsGroup', params.fG);
						loadHostGroupTypes(resultCache['host_groups'].results, 'hostmapGroupType', params.gT, true);
						loadHostGroupTypes(resultCache['host_groups'].results, 'hostmapFilterType', params.fT, true);
						loadHostGroupValues(resultCache['host_groups'].results, 'hostmapFilterValue', params.fT, params.fV, true);
					} catch(e) {
						error("Loading some host group definitions failed!");
					}
					$('#hostmapFilterType').change(function() {
						loadHostGroupValues(resultCache['host_groups'].results, 'hostmapFilterValue', $('#hostmapFilterType').val(), undefined, true);
					});

					$("#datepicker").val(data.date);
					$("#calendar").datepicker("setDate", data.date);

					$(id + " *").removeAttr('disabled');
				});

				$("#search").val(params.sT);
				$('#filterSettingsGo').click(callback);
			}

			function loadHostMap(params) {
				clean();
				$('#results').append('<div class="overviewBox"><div id="hostMapNav"/><div id="hostmap"/><div id="selectedGroup"/></div>');
	
				addFilterSettings('#hostMapNav', params, function() {
					setLocationHash({ view: 'hostmap', gT: $('#hostmapGroupType').val() });
				});

				if(params.fG)
					addHostsToMap(params);
				else
					$('#filterSettingsGo').trigger('click');
			}


    function getAlignmentBounds(vs, c) {
        var os = c.offsets;
        if (c.axis === 'x') {
            var x = vs[os[0].node].x;
            c.bounds = new cola.vpsc.Rectangle(x, x, 
                Math.min.apply(Math, os.map(function (o) { return vs[o.node].bounds.y - 20; })),
                Math.max.apply(Math, os.map(function (o) { return vs[o.node].bounds.Y + 20; })));
        } else {
            var y = vs[os[0].node].y;
            c.bounds = new cola.vpsc.Rectangle(
                Math.min.apply(Math, os.map(function (o) { return vs[o.node].bounds.x - 20; })),
                Math.max.apply(Math, os.map(function (o) { return vs[o.node].bounds.X + 20; })),
                y, y);
        }
        return c.bounds;
    }
			var netMapData;
			var viewBoxX, viewBoxY;

			function updateNetMapGraph() {
var width = $('#netmap').width();
    height = $('#netmap').height();

    var color = d3.scale.category20();

    var d3cola = cola.d3adaptor()
            .flowLayout("x", 400)
			//.symnetricDiffLinkLengths(6)
        .linkDistance(200)
		.convergenceThreshold(0.1)
        .avoidOverlaps(true)
        //.handleDisconnected(false)
        .size([width, height]);

    var svg = d3.select("#netmap").append("svg")
        .attr("width", width)
        .attr("height", height);


	// Allow panning as suggested in by dersinces (CC BY-SA 3.0) in
	// http://stackoverflow.com/questions/20099299/implement-panning-while-keeping-nodes-draggable-in-d3-force-layout
	var drag = d3.behavior.drag();
	drag.on('drag', function() {
	    viewBoxX -= d3.event.dx;
	    viewBoxY -= d3.event.dy;
	    svg.select('g.node-area').attr('transform', 'translate(' + (-viewBoxX) + ',' + (-viewBoxY) + ')');
	});
	svg.append('rect')
	  .classed('bg', true)
	  .attr('stroke', 'transparent')
	  .attr('fill', 'transparent')
	  .attr('x', 0)
	  .attr('y', 0)
	  .attr('width', width)
	  .attr('height', height)
	  .call(drag);

	var nodeArea = svg.append('g').classed('node-area', true);

	svg.append('svg:defs').append('svg:marker').attr('id', 'end-arrow').attr('viewBox', '0 -5 10 10').attr('refX', 5).attr('markerWidth', 9).attr('markerHeight', 6).attr('orient', 'auto').append('svg:path').attr('d', 'M0,-5L10,0L0,5L2,0').attr('stroke-width', '0px').attr('fill', '#000');

    graph = netMapData;
console.log(JSON.stringify(netMapData));
        graph.nodes.forEach(function (v) {
            v.width = 200;
			v.height = 40;
        })
        d3cola
            .nodes(graph.nodes)
            .links(graph.links)
			.groups(graph.groups)
			.constraints(graph.constraints)
            .start(100,0,0)

        var group = nodeArea.selectAll(".group")
            .data(graph.groups)
          .enter().append("rect")
            .attr("rx", 8).attr("ry", 8)
            .attr("class", "group")
            .style("fill", function (d, i) { if (i != 0) return color(i); else return '#fff' });

        var link = nodeArea.selectAll(".link")
            .data(graph.links)
          .enter().append("line")
            .attr("class", "link-line");

        var guideline = nodeArea.selectAll(".guideline")
            .data(graph.constraints.filter(function (c) { return c.type === 'alignment' }))
          .enter().append("line")
            .attr("class", "guideline")
            .attr("stroke-dasharray", "5,5");

        var pad = 5;
        var node = nodeArea.selectAll(".node")
            .data(graph.nodes)
          .enter().append("rect")
            .attr("class", "node")
            .attr("x", function (d) { return -d.width/2 + pad; })
            .attr("y", function (d) { return -d.height/2 + pad; })
            .attr("width", function (d) { return d.width - 2 * pad; })
            .attr("height", function (d) { return d.height - 2 * pad; })
            .attr("rx", 5).attr("ry", 5)
            .style("fill", function (d) { return color(graph.groups.length); })
            .call(d3cola.drag)
            .on('mouseup', function (d) {
                d.fixed = 0;
                d3cola.alpha(1); // fire it off again to satify gridify
            });

        var label = nodeArea.selectAll(".label")
            .data(graph.nodes)
           .enter().append("text")
            .attr("class", "label")
            .text(function (d) { return d.name; })
            .call(d3cola.drag);

        node.append("title")
            .text(function (d) { return d.name; });

        d3cola.on("tick", function () {
		    node.each(function (d) {
                    d.bounds.setXCentre(d.x);
                    d.bounds.setYCentre(d.y);
                    d.innerBounds = d.bounds.inflate(-0);
                });

				node.attr("transform", function (d) { return "translate(" + d.x + "," + d.y + ")"; });
			//	nodeArea.selectAll(".link-label").attr("transform", function (d) { return "translate(" + d.source.x + "," + (d.source.y+d.target.y)/2 + ")"; });


			link.each(function (d) {
				cola.vpsc.makeEdgeBetween(d, d.source.innerBounds, d.target.innerBounds, 5);
			});
	    	link.attr("x1", function (d) {
				return d.sourceIntersection.x;
			}).attr("y1", function (d) {
				return d.sourceIntersection.y;
			}).attr("x2", function (d) {
				return d.arrowStart.x;
			}).attr("y2", function (d) {
				return d.arrowStart.y;
			});
	   /*     node.attr("x", function (d) { return d.x - d.width / 2 + pad; })
                .attr("y", function (d) { return d.y - d.height / 2 + pad; });
        */    
            group.attr("x", function (d) { return d.bounds.x; })
                .attr("y", function (d) { return d.bounds.y; })
                .attr("width", function (d) { return d.bounds.width(); })
                .attr("height", function (d) { return d.bounds.height(); });

            guideline
                .attr("x1", function (d) { return getAlignmentBounds(graph.nodes, d).x; })
                .attr("y1", function (d) {
                    return d.bounds.y;
                })
                .attr("x2", function (d) { return d.bounds.X; })
                .attr("y2", function (d) {
                    return d.bounds.Y;
                });

            label.attr("x", function (d) { return d.x -d.width/2 + pad; })
                 .attr("y", function (d) {
                     var h = this.getBBox().height;
                     return d.y + h/4;
                 });
        });
			}

			function addHostToNetMap(host) {
				var nodeToId = new Array();
				netMapData = {
					nodes: [],
					links: [],
				    constraints: [
						{ type: "alignment", axis: "x", offsets: [] },
						{ type: "alignment", axis: "x", offsets: [] },
						{ type: "alignment", axis: "x", offsets: [] }
					],
					groups: [
						{ leaves: [0], groups: [1, 2, 3] },	// root
						{ leaves: [] }, // local node group
						{ leaves: [] }, // group for remote nodes connecting from
						{ leaves: [] }	// group for remote nodes connecting to
					]
				};
				// get connections for this host
				getData("Network", function(data) {
					$.each(data.results, function(i, item) {
						if(item.host == host && item.policy == "Connections") {
							var connections = item.message.split(/ /);
							for(var c in connections) {
								var fields = connections[c].split(/:/);
								if(fields[4]) {
									var localNode;
									if(fields[2] !== "-")
											localNode = fields[2];
									else
											localNode = "???";
									if(fields[1] !== "high")
											localNode += ":" + fields[1];

									$('#netMapTable').append('<tr><td>'+host+'</td><td>'+fields[0]+'</td><td>'+fields[1]+'</td><td>'+fields[2]+'</td><td>'+fields[3]+'</td><td>'+fields[4]+'</td></tr>');
									if(!nodeToId[localNode]) {
										nodeToId[localNode] = netMapData.nodes.length;
										netMapData.groups[1].leaves.push(nodeToId[localNode]);
										netMapData.constraints[0].offsets.push({node: nodeToId[localNode], offset:0});
										netMapData.nodes.push({name: localNode});
									}
									if(!nodeToId[fields[3]]) {
										nodeToId[fields[3]] = netMapData.nodes.length;
										if(fields[1] !== "high") {
											netMapData.groups[2].leaves.push(nodeToId[fields[3]]);
											netMapData.constraints[1].offsets.push({node: nodeToId[fields[3]], offset:0});
										} else {
											netMapData.groups[3].leaves.push(nodeToId[fields[3]]);
											netMapData.constraints[2].offsets.push({node: nodeToId[fields[3]], offset:0});
										}
										netMapData.nodes.push({name: fields[3]});
									}
									if(fields[1] !== "high")
										netMapData.links.push({target: nodeToId[localNode], source: nodeToId[fields[3]]});
									else
										netMapData.links.push({source: nodeToId[localNode], target: nodeToId[fields[3]]});
								}
							}
						}
					});
					updateNetMapGraph();
				});
			}

			function loadNetworkMap(params) {
				clean();
				$('#results').append('<div class="overviewBox"><div id="netmap" style="padding:12px;height:800px;width:100%;margin-bottom:12px;clear:both;border:1px solid black;"/><div id="selectedGroup"/><table id="netMapTable" class="resultTable"><tr><th>Host</th><th>Local IP</th><th>Local Port</th><th>Program</th><th>Remote IP</th><th>Remote Port</th></tr></table></div><div id="netMapNav"/>');


				addFilterSettings('#netMapNav', params, function() {
				});
				params.h = "lzone.de";
				if(params.h)
					addHostToNetMap(params.h);
			}

			function loadScannerResults(params) {
				console.log("Loading results start (search="+params.sT+")");
				clean();

				getData(params.fG, function(data) {
					$('#results').html('<div id="filter">');
					addFilterSettings('#filter', params, function() {
						setLocationHash({ sT: $('#search').val(), gI: $('#groupById').val() });
					});

					if(!params.gI)
						createResultTable(params, '#results', data.results);
					else
						createGroupTable(params, '#results', data.results);
	
					var badgeTitle;
					if(!params.fG || params.fG == "all") {
						if(params.sT)
							badgeTitle = "<small>Filter</small><br/> " + params.sT;
						else
							badgeTitle = "Overall";
					} else {
						badgeTitle = "<small>Group</small><br/> " + params.fG;
					}
	
					createBadges('#row1', failed, warning, badgeTitle);
					createHistogram(params.sT?params.sT:params.fG);
				});
			}

			function onLocationHashChange() {
				var params = {};

				try {
					// http://stackoverflow.com/questions/901115/how-can-i-get-query-string-values-in-javascript (2nd answer)
					var match,
					    pl = /\+/g,  // Regex for replacing addition symbol with a space
					    search = /([^&=]+)=?([^&]*)/g,
					    decode = function (s) { return decodeURIComponent(s.replace(pl, " ")); },
    					    query  = window.location.search.substring(1);

					while (match = search.exec(window.location.hash.substring(1)))
					       params[decode(match[1])] = decode(match[2]);
				} catch(e) {
					console.log("Invalid parameter encoding! "+e);
				}

				if(params.d) {
					var newBaseUrl = "results/json/"+params.d+"/";
					if(newBaseUrl != baseUrl) {
						resultCache = new Array();
						baseUrl = newBaseUrl;
						console.log("new baseurl="+baseUrl);
					}
				}

				// Delete empty search fields
				if(params.sT === "")
					delete params.sT;
				if(params.gI === "")
					delete params.gI;

				// FIXME: Update generic filter model
				getData('hosts', function(data) {
					hosts = data.results;

					$("#menu a.current").removeClass("current");

					if(params.view == "hostmap") {
						loadHostMap(params);
						$("#menu a[href='#view=hostmap']").addClass("current");
					} else if(params.view == "netmap") {
						loadNetworkMap(params);
						$("#menu a[href='#view=netmap']").addClass("current");
					} else if(!params.fG) {
						loadOverview();
						$("#menu a[href='#']").addClass("current");
					} else {
						loadScannerResults(params);
						$("#menu a[href='#view=results&fG="+params.fG+"']").addClass("current");
					}
				});
			}

			function setLocationHash(params, replace) {
				if(!replace) {
					// FIXME: Build a real filter model!
					// Merge add filter values...
					var filterType = $('#hostmapFilterType').val();
					var filterValue = $('#hostmapFilterValue').val();
					var findingsGroup = $('#findingsGroup').val();
	
					if(!params.fT && filterType) {
						params.fT = filterType;
						params.fV = filterValue;
					}
					if(!params.fG && findingsGroup)
						params.fG = findingsGroup;
				}
				if(!params.d)
					params.d = $('#datepicker').val();

				window.location.hash = "#" + $.param(params);
			}

			(function() {
				onLocationHashChange();

				// Allow some simple navigation by browser history 
				// for scanner results
				$(window).on('hashchange', onLocationHashChange);
			})();

			function shortenNumber(nr) {
				return (nr>1000)?Math.floor(nr/1000)+"k":nr;
			}

			function createBadges(id, failed, warning, name) {
				if(!name)
					name = "Overall";
				$("<div class='badges'><div class='badgesTitle'>" +
				  name +
				  "</div><div class='badge" +
				  ((failed>0)?" problems":"") +
				  "'><span class='count' title='"+failed+"'>" +
				  shortenNumber(failed) +
				  "</span> Problems</div><div class='badge" +
				  ((warning>0)?" warning":"") +
				  "'><span class='count' title='"+warning+"'>" +
				  shortenNumber(warning) +
				  '</span> Warnings</div></div>').appendTo(id);
			}

			function createHistogram(id) {
				getData("histogram", function(data) {
					var chartData = {
						labels: [],
						datasets: []
					};
					// Find ouf values
					var valueIndex;
					$.each(data.histogram, function(i, set) {
						if(set.id && set.id == id) {
							console.log("Found histogram data set at "+i);
							valueIndex = i;
						}
					});

					if(valueIndex) {
						$.each(data.labels, function(i, name) {
							chartData.labels[i] = name;
						});
						chartData.datasets[0] = {
							data: data.histogram[valueIndex].FAILED,
							label: id,
							strokeColor: "rgba(220,50,50,1)",
							fillColor: "rgba(250,250,250,0.2)"
						}
						chartData.datasets[1] = {
							data: data.histogram[valueIndex].WARNING,
							label: id,
							strokeColor: "#cc0",
							fillColor: "rgba(250,250,250,0.2)"
						}

						$('#row1').append('<div class="chart"><div class="chartTitle">Issue Trends</div><canvas id="histogramChart" width="600" height="200"></canvas></div>');
						var ctx = $("#histogramChart").get(0).getContext("2d");
						var myLineChart = new Chart(ctx).Line(chartData, {
							animation: false,
							showTooltips: false	// FIXME: disabled as long there is the bug of multiple dates being shown at the same time
						});
						$('#histogramChart').click(function(e) {
							setLocationHash({ d: myLineChart.getPointsAtEvent(e)[0].label });
						});
					} else {
						console.log("Could not find value set for "+all);
					}
				});
			}

			function clean() {
				$('#results').html('<div id="row1"></div><div id="loadmessage"><i>Loading ...</i></div><div id="row2"/>');
				$('#errors').hide();
				$('#loadmessage').hide();
			}

			function addPieChart(id, title, size, pColor, data) {
				return new d3pie(id, {
					"header": {
						"title": {
							"text": title,
							"color": "#fff",
						},
					},
					"size": {
						"canvasWidth": size*0.8,
						"canvasHeight": size,
						"pieOuterRadius": "90%"
					},
					"data": {
						"sortOrder": "value-desc",
						"content": data,
					},
					"tooltips": {
						"enabled": true,
						"type": "placeholder",
						"string": "{label}: \n{value}, {percentage}%"
					},
					"labels": {
						"outer": {
							"format": "none"
						},
						"inner": {
							"format": "label-percentage2",
							"hideWhenLessThanPercentage": 8
						},
						"mainLabel": {
							"fontSize": 16,
						},
						"percentage": {
							"color": pColor,
							"decimalPlaces": 0
						},
						"value": {
							"color": "#adadad",
							"fontSize": 10
						}
					},
					'callbacks': {
						'onClickSegment': function(segment) {
							setLocationHash({ fG: segment.data.label});
						}
					}
				});
			}

			function loadOverview() {

				clean();
				$("<div id='overviewBoxContainer'>").appendTo("#results");
				$("<div id='col2'>").appendTo("#overviewBoxContainer");
				$("<div id='col1'>").appendTo("#overviewBoxContainer");

				getData("overview", function(data) {
					$("#row1").append("<div class='chart'><span id='overviewCalendar'/></div>");
					addCalendar("#overviewCalendar", data.date);
					createBadges('#row1', data.FAILED, data.WARNING);
					$("#loadmessage").hide();

					var groupFailed = new Array();
					var groupWarning = new Array();
					var pieGroupHosts = new Array();
		   			$.each(data.overview, function(i, item) {
						if(item.group) {
							var compliant = 1;
							var tmp = '<span class="name">' +
							item.group +
							'</span>';
							if(item.FAILED > 0) {
								groupFailed.push({
									"label": item.group,
									"value": item.FAILED,
									"color": "#ff0000"
								});
								compliant = 0;
								tmp += ' <span class="FAILED" title="Total failures found">' +
								item.FAILED +
								'</span>';
							}
							if(item.WARNING > 0) {
								groupWarning.push({
									"label": item.group,
									"value": item.WARNING,
									"color": "#ee0"
								});
								compliant = 0;
								tmp += ' <span class="WARNING" title="Total warnings seen">' +
								item.WARNING +
								'</span>'
							}
							if(compliant) {
								tmp += ' <span class="compliant" title="100% compliance for this group">compliant</span>';
							}
						}
		   			});

					$("<div id='findingsPies' class='overviewBox dark'>").appendTo("#row1");
					$("<div id='pieChartFailed' class='pie'>").appendTo("#findingsPies");
					$("<div id='pieChartWarning' class='pie'>").appendTo("#findingsPies");
					addPieChart('pieChartFailed', 'Problems', 260, '#fff', groupFailed);
					addPieChart('pieChartWarning', 'Warnings', 260, '#777' ,groupWarning);
					// FIXME: addPieChart('pieChartHosts', 'Warnings', 260, pieGroupHosts);

					$( "<div id='policies' class='overviewBox'>" ).appendTo( "#row2" )
					$( "<h3>Findings / Changes per Policy</h3><table class='resultTable tablesorter' id='findingsPerPolicy'><thead><tr><th>Group</th><th>Policy</th><th>Problems</th><th>Change</th><th>Warnings</th><th>Change</th></tr></thead><tbody></tbody></table>").appendTo("#policies")

		   			getData("histogram", function(data) {
					$.each(data.histogram, function(i, item ) {
						if(-1 != item.id.indexOf(":::")) {
							var compliant = 1;
							var group, policy, failed, failed2, warning, warning2, diff;
							try {
								group = item.id.split(/:::/)[0];
								policy = item.id.split(/:::/)[1];
								failed = item.FAILED[item.FAILED.length-1];
								failed2 = item.FAILED[item.FAILED.length-2];
								warning = item.WARNING[item.WARNING.length-1];
								warning2 = item.WARNING[item.WARNING.length-2];
							} catch(e) {
								console.log("Failed to get values for "+item.id+" Exception:"+e);
							}
							var tmp = '<tr><td class="group" title="'+item.description+'" filter="' + group + '">' + group + '</td><td class="policy" filter="' + group + '---' + policy + '">' + (policy?policy:"") + '</td>';
							tmp += '<td>';
							if(failed > 0)
								tmp += '<span class="FAILED" title="Total failures found">' + failed + '</span>';
							else
								tmp += '<span title="Total failures found">0</span>';
							tmp += '</td><td class="change">';
							diff = failed - failed2;
							if(diff != 0)
								tmp += '<span class="'+(diff>0?"FAILED":"compliant")+' changes" filter="'+(diff>0?'new':'solved')+'---' + policy + '" title="Total change problems">+' + Math.abs(diff) + '</span>';
							tmp += '</td><td>';
							if(warning > 0)
								tmp += '<span class="WARNING" title="Total warnings seen">' + warning + '</span>';
							else
								tmp += '<span title="Total warnings found">0</span>';
							tmp += '</td><td class="change">';
							diff = warning - warning2;
							if(diff != 0)
								tmp += '<span class="'+(diff>0?"WARNING":"compliant")+' changes" filter="'+(diff>0?'new':'solved')+'---' + policy + '" title="Total change warnings">+' + Math.abs(diff) + '</span>';
							tmp += '</td>';
							tmp += '</tr>';
							$("#findingsPerPolicy").append(tmp);

						}
		   			});
					$("#findingsPerPolicy").tablesorter({sortList: [[3,1],[2,1],[5,1],[4,1]]});

					$("#findingsPerPolicy .group").click(function() {
						setLocationHash({ fG: $(this).attr('filter') });
					});
					$("#findingsPerPolicy .policy").click(function() {
						var fields = $(this).attr('filter').split(/---/);
						setLocationHash({
							fG: fields[0],
							sT: fields[1]
						});
					});
					$("#findingsPerPolicy .change").click(function() {
						var fields = $(this).find('.changes').attr('filter').split(/---/);
						setLocationHash({
							fG: fields[0],
							sT: fields[1]
						});
					});
        			});
					});
				createHistogram('all');
			}
		</script>
	</body>
</html>
