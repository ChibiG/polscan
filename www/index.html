<!doctype html>
<html>
	<head>
		<script type="text/javascript" src="jquery-2.1.4.min.js"></script>
		<script type="text/javascript" src="jquery.tablesorter.min.js"></script>
		<link rel="stylesheet" href="jquery-ui.min.css">
		<script src="jquery-ui.min.js"></script>
		<meta charset="utf-8">
		<style type="text/css">
			body {
				font-family: Helvetica;
				background:#eee;
			}
			.section {
				background:white;
				border: 1px solid #ccc;
				border-radius: 6px;
				padding:12px 24px;
			}
			.group, .policy {
				background: #ddd;
				padding: 0 12px;
				cursor: pointer;
			}
			.group:hover, .policy:hover {
				background: #ccc;
			}
			.FAILED {
				background: #f44;
				padding: 0 6px;
			}
			.WARNING {
				background: #ff4;
				padding: 0 6px;
			}
			.OK {
				background: #7f7;
				padding: 0 6px;
			}
			.errorbox {
				padding: 24px;
				padding-top:0;
				margin:12px;
				background: #f44;
				border: 3px solid #f22;
			}
			.description {
				display:block;
				font-style:italic;
				font-size: 80%;
				color: gray;
				padding:6px;
				padding-left:24px;
			}
			#resultTable {
				border: 1px solid #aaa;
				font-size:12pt;
				border-collapse: collapse;
			}
			#resultTable th {
				background: #ddd;
				border: 1px solid #aaa;
			}
			#resultTable td {
				padding: 6px 12px;
				border: 1px solid #aaa;
			}
			tr:nth-child(even) {
				background:#eee;
			}
			tr:nth-child(odd) {
				background:white;
			}
			th.headerSortUp:after {
				content: " ↑";
			}
			th.headerSortDown:after {
				content: " ↓";
			}
		</style>
	</head>
	<body>
		<div id='menu'>
			[<a href="">Overview</a>] [<a href="javascript:loadScannerResults('all')">All Problems</a>]
		</div>

		<h2 id='resultTitle'/></h2>

		<p>Date <input type='text' id='datepicker' size='10'/></p>

		<div id='results'>
		</div>

		<script>
			function error(text) {
				$('#results').html('<div class="errorbox"><h2>Error</h2> '+text+'</div>');
			}

			function loadScannerResults(name, searchValue, filtered) {
 				var group = '';
				if (name == 'all')
					group = '<th>Group</th>';

				$('#resultTitle').html("Results '"+name+"'");
				$('#results').html('Search <input type="text" size="40" id="search"/> <input type="button" value="Go" onclick="onSearch();"/><br/><br/>');
				$("<table id='resultTable' class='tablesorter'>")
				.html("<thead><tr><th>Host</th>"+group+"<th>Policy</th><th>Details</th></thead>")
				.appendTo('#results');

				$.getJSON("results/latest/"+name+".json", {})
		        	 .done(function( data ) {
			   		$.each( data.results, function( i, item ) {
						if(!filtered || item.severity.indexOf('OK') == -1) {

						var tmp = '<td class="host">' + item.host + '</td>';
						if(item.group)
							tmp += '<td class="group">' + item.group + '</td>';
						tmp +=
						'<td class="policy '+item.severity+'">' + item.policy + '</td>' +
						'<td class="message">' + item.message + '</td>';
						$( "<tr>" )
						.html(tmp)
						.appendTo("#resultTable");
						}
					});
					$("#resultTable").tablesorter();
					$("#search").val(searchValue);
					onSearch();

					$(".group").click(function() {
						loadScannerResults($(this).html(), "", true);
					});
					$(".policy").click(function() {
						loadScannerResults("all", $(this).html(), true);
					});
				})
				.fail(function(j, t, e) {
					error('Fetching results for '+name+' failed! ' + t + " " + e);
				});
			}

			(function() {
				onDateSelect();
			})();

			function onSearch() {
				var searchText = $('#search').val();

				$("td").parent().hide();
				$("td").filter(function() {
					return $(this).text().indexOf(searchText) !== -1;
				}).parent().show();
			}

			function onDateSelect(day) {
				var url;

				if(day)
					url = "results/json/"+day+"/overview.json";
				else
					url = "results/latest/overview.json";

				$.getJSON(url, {})
		        		.done(function( data ) {
						$('#resultTitle').html("Policy Scan Overview");
						$('#results').html('');
						$( "<h3>" ).html("By Groups").appendTo( "#results" )
						$( "<div id='groups' class='section'>" ).appendTo( "#results" )

			   			$.each( data.overview, function( i, item ) {
							if(item.group) {
								var compliant = 1;
								var tmp = '<span class="group">' +
								item.group +
								'</span>';
								if(item.FAILED > 0) {
									compliant = 0;
									tmp += ' <span class="FAILED" title="Total failures found">' +
									item.FAILED +
									'</span>';
								}
								if(item.WARNING > 0) {
									compliant = 0;
									tmp += ' <span class="WARNING" title="Total warnings seen">' +
									item.WARNING +
									'</span>'
								}
								if(compliant) {
									tmp += ' <span class="OK" title="100% compliance for this policy">compliant</span>';
								}

								$( "<p>" )
								.html(tmp)
								.appendTo( "#groups" );

							}
			   			});

						$( "<h3>" ).html("Policy Details").appendTo( "#results" )
						$( "<div id='policies' class='section'>" ).appendTo( "#results" )

			   			$.each( data.overview, function( i, item ) {
							if(item.policy) {
								var compliant = 1;
								var tmp = '<span class="group">' +
								item.parent +
								'</span> <span class="policy">' +
								item.policy +
								'</span>';
								if(item.FAILED > 0) {
									compliant = 0;
									tmp += ' <span class="FAILED" title="Total failures found">' +
									item.FAILED +
									'</span>';
								}
								if(item.WARNING > 0) {
									compliant = 0;
									tmp += ' <span class="WARNING" title="Total warnings seen">' +
									item.WARNING +
									'</span>'
								}
								if(compliant) {
									tmp += ' <span class="OK" title="100% compliance for this policy">compliant</span>';
								}
								tmp += '<span class="description">' +
								item.description +
								'</span>';

								$( "<p>" )
								.html(tmp)
								.appendTo( "#policies" );

							}
							$("#datepicker").val(data.date);
							$("#datepicker").datepicker({
								dateFormat: "yy/mm/dd",
								onSelect: onDateSelect
							});
			   			});
						$(".group").click(function() {
							loadScannerResults($(this).html(), "", true);
						});
						$(".policy").click(function() {
							loadScannerResults("all", $(this).html(), true);
						});
		        		})
					.fail(function(j, t, e) {
						error('Fetching overview results failed! ' + t + " " +e);
					});
			}
		</script>
	</body>
</html>
